<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order - DrapeMe Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #e4002b;
            --secondary-color: #333;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --background-light: #f8f9fa;
        }
        body {
            background: linear-gradient(to bottom, var(--background-light), #fff1f8);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding-top: 56px;
        }
        .navbar {
            background: #fff !important;
            border-bottom: 4px solid var(--primary-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
        }
        .navbar-brand img {
            max-width: 70px;
        }
        .nav-link {
            font-weight: bold;
            color: var(--secondary-color) !important;
            transition: 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color) !important;
        }
        .profile-btn {
            width: 45px;
            height: 45px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tracking-container {
            max-width: 900px;
            margin: 50px auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(228,0,43,0.2);
            padding: 40px;
            animation: fadeInUp 1s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tracking-title {
            font-size: 2.8rem;
            color: var(--primary-color);
            text-shadow: 2px 2px 8px rgba(228,0,43,0.3);
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px var(--primary-color); }
            to { text-shadow: 0 0 30px var(--primary-color), 0 0 40px #ff6b9d; }
        }
        .product-img {
            width: 150px;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .timeline {
            position: relative;
            margin: 40px 0;
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #ddd;
            transform: translateY(-50%);
        }
        .timeline-step {
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .step-icon {
            width: 60px;
            height: 60px;
            background: #ddd;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 15px;
            transition: all 0.5s ease;
        }
        .step-icon.active {
            background: var(--success-color);
            animation: pulse-active 1.5s infinite;
        }
        .step-icon.pending {
            background: var(--warning-color);
        }
        .step-icon.completed {
            background: var(--info-color);
        }
        @keyframes pulse-active {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40,167,69,0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(40,167,69,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40,167,69,0); }
        }
        .confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        footer {
            background: var(--secondary-color);
            color: white;
            padding: 60px 0 30px;
            margin-top: auto;
        }
        @media (max-width: 576px) {
            .tracking-container { padding: 20px; }
            .tracking-title { font-size: 2rem; }
            .product-img { width: 120px; height: 160px; }
            .step-icon { width: 50px; height: 50px; font-size: 1.5rem; }
        }
    </style>
</head>
<body>
<!-- Confetti Canvas -->
<canvas id="confettiCanvas" class="confetti-canvas"></canvas>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="home.html">
            <img src="assets/css/images/logo.png" alt="logo">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav m-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="sarees.html">Sarees</a></li>
                <li class="nav-item"><a class="nav-link" href="jewellery.html">Jewellery</a></li>
                <li class="nav-item"><a class="nav-link" href="sales.html">Sales</a></li>
            </ul>
            <div class="d-flex align-items-center gap-3">
                <a href="cart.html" class="position-relative text-dark fs-4 fw-bold">
                    <i class="bi bi-cart-fill"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-count">0</span>
                </a>
                <div class="dropdown">
                    <button class="btn profile-btn" data-bs-toggle="dropdown">
                        <span id="user-initial">G</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-2">
                        <li><a class="dropdown-item rounded py-2" href="home.html">My Profile</a></li>
                      
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item rounded py-2 text-danger fw-bold" onclick="logout()">Logout</button></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
<!-- Tracking Section -->
<div class="container my-5">
    <div class="tracking-container">
        <h1 class="tracking-title text-center mb-5">Track Your Precious Order</h1>
        <div id="tracking-content" class="text-center">
            <!-- Dynamic content here -->
        </div>
    </div>
</div>
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4">
                <h3>Drape<span>Me Store</span></h3>
                <p>Your one-stop shop for elegant sarees and jewellery.</p>
            </div>
            <div class="col-md-4 mb-4">
                <h5 class="fw-bold mb-3">Quick Links</h5>
                <ul class="list-unstyled">
                    <li><a href="home.html" class="text-white text-decoration-none">Home</a></li>
                    <li><a href="sarees.html" class="text-white text-decoration-none">Sarees</a></li>
                    <li><a href="jewellery.html" class="text-white text-decoration-none">Jewellery</a></li>
                    <li><a href="sales.html" class="text-white text-decoration-none">Sales</a></li>
                </ul>
            </div>
            <div class="col-md-4 mb-4">
                <h5 class="fw-bold mb-3">Contact Us</h5>
                <p><i class="bi bi-geo-alt-fill me-2"></i>Krishna Lonari, Mumbai Andheri 540</p>
                <p><i class="bi bi-telephone-fill me-2"></i>+91 7767958085</p>
                <p><i class="bi bi-envelope-fill me-2"></i>krishna@demo.com</p>
                <div class="mt-3">
                    <a href="#" class="text-white me-3 fs-4"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="text-white me-3 fs-4"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="text-white me-3 fs-4"><i class="bi bi-youtube"></i></a>
                    <a href="#" class="text-white me-3 fs-4"><i class="bi bi-whatsapp"></i></a>
                </div>
            </div>
        </div>
        <hr class="my-4">
        <p class="text-center mb-0">&copy; 2025 Jordan Demo Store. All rights reserved.</p>
    </div>
</footer>
<script>
    // Auth Protection
    if (!localStorage.getItem("auth_token")) {
        alert("Please login first!");
        window.location.href = "index.html";
    }
    // User Initial & Cart Count
    const user = JSON.parse(localStorage.getItem("current_user") || "{}");
    document.getElementById("user-initial").textContent = (user.name || user.email || "G").charAt(0).toUpperCase();
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");
    document.getElementById("cart-count").textContent = cart.length;
    function logout() {
        if (confirm("Are you sure you want to logout?")) {
            localStorage.removeItem("auth_token");
            localStorage.removeItem("current_user");
            localStorage.removeItem("isAdmin");
            window.location.href = "index.html";
        }
    }
    // Confetti Celebration
    function throwConfetti() {
        const canvas = document.getElementById('confettiCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const confettiCount = 300;
        const confetti = [];
        for (let i = 0; i < confettiCount; i++) {
            confetti.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                r: Math.random() * 6 + 2,
                d: Math.random() * confettiCount,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                tilt: Math.random() * 10 - 10,
                tiltAngleIncremental: Math.random() * 0.07 + 0.05,
                tiltAngle: 0
            });
        }
        function drawConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            confetti.forEach((c, idx) => {
                c.tiltAngle += c.tiltAngleIncremental;
                c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
                c.x += Math.sin(c.d) * 0.5;
                c.tilt = Math.sin(c.tiltAngle) * 15;
                if (c.y > canvas.height) {
                    confetti.splice(idx, 1);
                } else {
                    ctx.beginPath();
                    ctx.lineWidth = c.r;
                    ctx.strokeStyle = c.color;
                    ctx.moveTo(c.x + c.tilt + c.r / 4, c.y);
                    ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 4);
                    ctx.stroke();
                }
            });
            if (confetti.length > 0) {
                requestAnimationFrame(drawConfetti);
            } else {
                canvas.style.display = 'none';
            }
        }
        drawConfetti();
    }

    // New: Cancel Order Function
    function cancelOrder(trackId) {
        if (!confirm("Are you sure you want to cancel this order? This action cannot be undone.")) {
            return;
        }
        let orders = JSON.parse(localStorage.getItem("orders") || "[]");
        const index = orders.findIndex(o => o.trackID === trackId);
        if (index === -1) {
            alert("Order not found.");
            return;
        }
        const order = orders[index];
        if (order.status === "Cancelled") {
            alert("This order is already cancelled.");
            return;
        }
        order.status = "Cancelled";
        orders[index] = order;
        localStorage.setItem("orders", JSON.stringify(orders));
        alert("Your order has been successfully cancelled. Any refund will be processed within 5-7 business days.");
        renderOrderDetails(order);  // Re-render with updated status
    }

    // Tracking Logic
    const params = new URLSearchParams(window.location.search);
    let trackId = params.get("trackid");
    let orders = JSON.parse(localStorage.getItem("orders") || "[]");
    let order = orders.find(o => o.trackID === trackId);
    const content = document.getElementById("tracking-content");
    if (!trackId) {
        content.innerHTML = `
            <div class="mb-5">
                <h4 class="text-center mb-4">Enter Tracking ID</h4>
                <form id="trackForm" class="d-flex justify-content-center gap-3">
                    <input type="text" class="form-control w-50" id="trackInput" placeholder="Enter your tracking ID" required>
                    <button type="submit" class="btn btn-primary btn-lg">Track Order</button>
                </form>
            </div>
        `;
        document.getElementById('trackForm').addEventListener('submit', (e) => {
            e.preventDefault();
            trackId = document.getElementById('trackInput').value.trim();
            order = orders.find(o => o.trackID === trackId);
            if (order) {
                window.history.pushState({}, '', `?trackid=${trackId}`);
                renderOrderDetails(order);
            } else {
                content.innerHTML += `<p class="text-danger mt-3">Invalid tracking ID. Please try again.</p>`;
            }
        });
    } else if (order) {
        renderOrderDetails(order);
    } else {
        content.innerHTML = `
            <p class="fs-4 text-danger mb-4">No order found with this tracking ID.</p>
            <a href="home.html" class="btn btn-outline-primary btn-lg">Back to Home</a>
        `;
    }

    function renderOrderDetails(order) {
        const p = order.product;
        const statuses = ['Placed', 'Processing', 'Shipped', 'Out for Delivery', 'Delivered'];
        // Simulated progress (random for demo)
        let currentStatusIndex = Math.min(Math.floor(Math.random() * statuses.length), 4);
        // If already cancelled, override
        const isCancelled = order.status === "Cancelled";
        const isCancellable = !isCancelled && currentStatusIndex < 3;  // Can cancel only before 'Out for Delivery'

        let extraStatusHTML = "";
        if (isCancelled) {
            extraStatusHTML = '<p class="fs-4 text-danger fw-bold mb-4">Order Cancelled</p><p class="text-muted mb-4">Your cancellation has been processed.</p>';
        } else {
            extraStatusHTML = `<p class="fs-5 text-success">Estimated Delivery: <strong>${getEstimatedDelivery()}</strong></p>`;
        }

        let timelineHTML = "";
        if (isCancelled) {
            timelineHTML = '<div class="text-center my-5"><i class="bi bi-x-circle-fill text-danger" style="font-size: 5rem;"></i></div>';
        } else {
            statuses.forEach((status, idx) => {
                let iconClass = idx < currentStatusIndex ? 'bi-check-circle-fill text-success' :
                                (idx === currentStatusIndex ? 'bi-hourglass-split text-warning' : 'bi-circle text-muted');
                timelineHTML += `
                    <div class="col timeline-step">
                        <div class="step-icon ${idx <= currentStatusIndex ? 'active' : 'pending'}">
                            <i class="bi ${iconClass}"></i>
                        </div>
                        <p class="fw-bold">${status}</p>
                        <p class="text-muted small">${idx <= currentStatusIndex ? 'Completed' : 'Pending'}</p>
                    </div>
                `;
            });
        }

        let cancelButtonHTML = "";
        if (isCancellable) {
            cancelButtonHTML = `<button class="btn btn-outline-danger btn-lg mt-3" onclick="cancelOrder('${order.trackID}')">
                                  <i class="bi bi-x-circle me-2"></i>Cancel Order
                               </button>`;
        }

        content.innerHTML = `
            <div class="row align-items-center mb-5">
                <div class="col-md-3 text-center">
                    <img src="${p.image || p.images[0]}" class="product-img" alt="${p.title}">
                </div>
                <div class="col-md-9">
                    <h3 class="fw-bold">${p.title}</h3>
                    <p class="text-muted mb-2">${p.category} â€¢ Order ID: ${order.trackID}</p>
                    <p class="price mb-0">$${p.price.toFixed(2)}</p>
                    ${extraStatusHTML}
                </div>
            </div>
            <h4 class="fw-bold mb-4 text-center">Order Journey</h4>
            <div class="row timeline">
                ${timelineHTML}
            </div>
            <div class="text-center mt-5">
                <a href="home.html" class="btn btn-primary btn-lg mt-3 me-3">Continue Shopping</a>
                ${cancelButtonHTML}
            </div>
        `;

        // Trigger confetti only if delivered and not cancelled
        if (currentStatusIndex === 4 && !isCancelled) {
            throwConfetti();
        }
    }

    function getEstimatedDelivery() {
        const date = new Date();
        date.setDate(date.getDate() + Math.floor(Math.random() * 7) + 3);
        return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
</script>
</body>
</html>
